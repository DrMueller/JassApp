@page "/tts-check"
@using Microsoft.JSInterop
@inject IJSRuntime Js

<h3>TTS Check</h3>

<p>API supported: <b>@_supported</b></p>
<p>Test result (button): <b>@_testResult</b></p>

<MudBlazor.MudButton class="btn btn-primary" OnClick="CheckSupport">Check support</MudBlazor.MudButton>
<MudBlazor.MudButton class="btn btn-success ms-2" OnClick="RunTest">Run test (iPhone needs this click)</MudBlazor.MudButton>
<MudBlazor.MudButton class="btn btn-secondary ms-2" OnClick="SpeakHello">Speak "Hallo"</MudBlazor.MudButton>

@code {
    private IJSObjectReference? _tts;
    private bool _supported;
    private string _testResult = "-";

    protected override async Task OnInitializedAsync()
    {
        _tts = await Js.InvokeAsync<IJSObjectReference>("import", "./tts.js");
        _supported = await _tts.InvokeAsync<bool>("isSupported");
    }

    private async Task CheckSupport()
    {
        if (_tts is null) return;
        _supported = await _tts.InvokeAsync<bool>("isSupported");
    }

    private async Task RunTest()
    {
        if (_tts is null) return;

        var ok = await _tts.InvokeAsync<bool>("testSpeak", "de-CH");
        _testResult = ok ? "OK (should work here)" : "FAILED (likely blocked or unsupported)";
    }

    private async Task SpeakHello()
    {
        if (_tts is null) return;

        // On iPhone: do this only after the user has successfully run the test once.
        await _tts.InvokeVoidAsync("speak", "Hallo! Das ist ein Test.", "de-CH");
    }

    public async ValueTask DisposeAsync()
    {
        if (_tts is not null) await _tts.DisposeAsync();
    }

}